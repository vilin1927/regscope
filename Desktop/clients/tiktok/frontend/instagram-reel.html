<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Reel Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('auth', { authenticated: false });
        });
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .dropzone { border: 2px dashed #4B5563; }
        .dropzone.dragover { border-color: #A855F7; background: rgba(168, 85, 247, 0.05); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Password Protection Modal -->
    <div x-data="accessControl()" x-show="!isAuthenticated" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-4">
                <span class="text-4xl">&#128274;</span>
                <h2 class="text-xl font-bold text-white mt-2">Access Required</h2>
                <p class="text-gray-400 text-sm">Enter password to continue</p>
            </div>
            <form @submit.prevent="verifyAccess">
                <input type="password" x-model="accessPassword" placeholder="Password"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 mb-3" autofocus>
                <div x-show="accessError" class="text-red-400 text-sm mb-3 text-center" x-text="accessError"></div>
                <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-white transition-colors"
                    :disabled="!accessPassword || verifying">
                    <span x-show="!verifying">Access</span>
                    <span x-show="verifying">Verifying...</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="container mx-auto px-4 py-8 max-w-5xl" x-data="reelGenerator()" x-init="init()"
         x-show="$store.auth.authenticated" x-cloak>

        <!-- Header -->
        <div class="text-center mb-8">
            <a href="/" class="absolute top-4 left-4 text-gray-500 hover:text-gray-300 text-sm">&larr; Back</a>
            <h1 class="text-3xl font-bold text-white mb-2">Instagram Reel Generator</h1>
            <p class="text-gray-400">Create unique reel variations from your assets</p>
        </div>

        <!-- Step Indicator -->
        <div class="flex items-center justify-center mb-8 space-x-2">
            <template x-for="(label, i) in ['Format', 'Assets', 'Text', 'Generate', 'Progress']" :key="i">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold transition-colors"
                         :class="currentStep > i+1 ? 'bg-green-600 text-white' : currentStep === i+1 ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-400'">
                        <span x-show="currentStep <= i+1" x-text="i+1"></span>
                        <span x-show="currentStep > i+1">&#10003;</span>
                    </div>
                    <span class="ml-1 text-sm hidden sm:inline"
                          :class="currentStep === i+1 ? 'text-white font-medium' : 'text-gray-500'" x-text="label"></span>
                    <span x-show="i < 4" class="mx-2 text-gray-600">/</span>
                </div>
            </template>
        </div>

        <!-- ==================== STEP 1: FORMAT ==================== -->
        <div x-show="currentStep === 1" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-white mb-4">Step 1: Choose Format</h2>

            <!-- Scrape new format -->
            <div class="mb-6">
                <h3 class="text-gray-300 font-medium mb-2">Scrape from Instagram</h3>
                <div class="flex gap-3">
                    <input x-model="scrapeUrl" placeholder="https://instagram.com/reel/..."
                        class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                    <input x-model="scrapeFormatName" placeholder="Format name"
                        class="w-48 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                    <button @click="scrapeFormat()" :disabled="scraping || !scrapeUrl || !scrapeFormatName"
                        class="px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold text-white transition-colors whitespace-nowrap">
                        <span x-show="!scraping">Scrape</span>
                        <span x-show="scraping">Scraping...</span>
                    </button>
                </div>
                <div x-show="scrapeError" class="text-red-400 text-sm mt-2" x-text="scrapeError"></div>
            </div>

            <!-- OR select saved format -->
            <div class="mb-6">
                <h3 class="text-gray-300 font-medium mb-2">Or select saved template</h3>
                <div x-show="formats.length === 0" class="text-gray-500 text-sm">No saved templates yet. Scrape an IG reel above.</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <template x-for="fmt in formats" :key="fmt.id">
                        <div @click="selectFormat(fmt)"
                             class="p-4 rounded-lg border cursor-pointer transition-colors"
                             :class="selectedFormat?.id === fmt.id ? 'border-purple-500 bg-purple-900/20' : 'border-gray-600 bg-gray-700 hover:border-gray-500'">
                            <div class="font-medium text-white" x-text="fmt.format_name"></div>
                            <div class="text-gray-400 text-sm mt-1">
                                <span x-text="fmt.clips?.length || 0"></span> clips &middot;
                                <span x-text="(fmt.total_duration || 0).toFixed(1)"></span>s
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Selected format clip editor -->
            <div x-show="selectedFormat" class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-gray-300 font-medium mb-3">Clip Structure
                    <span class="text-gray-500 text-sm">(editable)</span>
                </h3>
                <div class="space-y-2">
                    <template x-for="(clip, ci) in selectedFormat?.clips || []" :key="ci">
                        <div class="flex items-center gap-3 bg-gray-600 rounded-lg p-3">
                            <span class="text-gray-400 text-sm w-16">Clip <span x-text="ci+1"></span></span>
                            <input type="number" step="0.1" min="0.5" :value="clip.duration"
                                @change="clip.duration = parseFloat($event.target.value)"
                                class="w-20 px-2 py-1 bg-gray-700 border border-gray-500 rounded text-white text-sm">
                            <span class="text-gray-400 text-sm">sec</span>
                            <select :value="clip.type" @change="clip.type = $event.target.value"
                                class="px-3 py-1 bg-gray-700 border border-gray-500 rounded text-white text-sm">
                                <option value="before">Before</option>
                                <option value="after">After</option>
                                <option value="cta">CTA</option>
                                <option value="transition">Transition</option>
                            </select>
                            <select :value="clip.text_position || 'bottom'" @change="clip.text_position = $event.target.value"
                                class="px-3 py-1 bg-gray-700 border border-gray-500 rounded text-white text-sm">
                                <option value="top">Text: Top</option>
                                <option value="center">Text: Center</option>
                                <option value="bottom">Text: Bottom</option>
                            </select>
                        </div>
                    </template>
                </div>
                <button @click="saveFormatEdits()" class="mt-3 px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white text-sm">
                    Save Changes
                </button>
            </div>

            <div class="flex justify-end">
                <button @click="nextStep()" :disabled="!selectedFormat"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold text-white transition-colors">
                    Continue &rarr;
                </button>
            </div>
        </div>

        <!-- ==================== STEP 2: ASSETS ==================== -->
        <div x-show="currentStep === 2" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-white mb-4">Step 2: Manage Assets</h2>

            <!-- Create character -->
            <div class="flex gap-3 mb-6">
                <input x-model="newCharacterName" placeholder="New character name (e.g. jessica_30s_brunette)"
                    class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                <button @click="createCharacter()" :disabled="!newCharacterName.trim()"
                    class="px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-lg font-semibold text-white transition-colors">
                    + Create
                </button>
            </div>

            <!-- Character list -->
            <div x-show="characters.length === 0" class="text-gray-500 text-center py-8">
                No characters yet. Create one above.
            </div>

            <template x-for="char in characters" :key="char.id">
                <div class="mb-4 bg-gray-700 rounded-lg overflow-hidden">
                    <!-- Character header -->
                    <div @click="toggleCharacter(char.id)" class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-650">
                        <div>
                            <span class="font-medium text-white" x-text="char.character_name"></span>
                            <span class="text-gray-400 text-sm ml-2">
                                (<span x-text="char.before_photos || 0"></span> BP,
                                <span x-text="char.after_photos || 0"></span> AP,
                                <span x-text="char.before_videos || 0"></span> BV,
                                <span x-text="char.after_videos || 0"></span> AV)
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click.stop="deleteCharacter(char.id)" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                            <span class="text-gray-400" x-text="expandedCharacter === char.id ? '&#9650;' : '&#9660;'"></span>
                        </div>
                    </div>

                    <!-- Asset upload zones (expanded) -->
                    <div x-show="expandedCharacter === char.id" x-transition class="p-4 pt-0 grid grid-cols-2 gap-3">
                        <template x-for="assetType in ['before_photo', 'after_photo', 'before_video', 'after_video']" :key="assetType">
                            <div class="bg-gray-600 rounded-lg p-3">
                                <div class="text-gray-300 text-sm font-medium mb-2" x-text="assetType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) + 's'"></div>
                                <div class="dropzone rounded-lg p-4 text-center cursor-pointer hover:border-purple-400 transition-colors"
                                     @dragover.prevent="$event.currentTarget.classList.add('dragover')"
                                     @dragleave.prevent="$event.currentTarget.classList.remove('dragover')"
                                     @drop.prevent="handleAssetDrop($event, char.id, assetType)"
                                     @click="$refs['file_'+char.id+'_'+assetType].click()">
                                    <p class="text-gray-400 text-sm">Drop files or click to upload</p>
                                    <input type="file" multiple :ref="'file_'+char.id+'_'+assetType"
                                        @change="handleAssetSelect($event, char.id, assetType)"
                                        :accept="assetType.includes('video') ? '.mp4,.mov' : '.jpg,.jpeg,.png,.webp'"
                                        class="hidden">
                                </div>
                                <!-- Upload progress -->
                                <div x-show="uploadingKey === char.id+'_'+assetType" class="text-purple-400 text-xs mt-1">Uploading...</div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <div class="flex justify-between mt-6">
                <button @click="prevStep()" class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold text-white transition-colors">
                    &larr; Back
                </button>
                <button @click="nextStep()" :disabled="characters.length === 0"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold text-white transition-colors">
                    Continue &rarr;
                </button>
            </div>
        </div>

        <!-- ==================== STEP 3: TEXT ==================== -->
        <div x-show="currentStep === 3" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-white mb-4">Step 3: Text Configuration</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Hook text -->
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Hook Text (Clip 1)</label>
                    <textarea x-model="hookText" rows="3" placeholder="POV: you lose face fat"
                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 resize-none"></textarea>
                    <div class="mt-2 p-3 rounded-lg bg-black/50 border border-gray-600">
                        <p class="text-white text-sm font-medium" x-text="hookText || 'Preview...'"></p>
                        <p class="text-gray-500 text-xs mt-1">White text on dark background</p>
                    </div>
                </div>

                <!-- CTA text -->
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">CTA Text (Last Clip)</label>
                    <textarea x-model="ctaText" rows="3" placeholder="see how I did it &#11015;&#65039;"
                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 resize-none"></textarea>
                    <div class="mt-2 p-3 rounded-lg bg-white border border-gray-300">
                        <p class="text-black text-sm font-medium" x-text="ctaText || 'Preview...'"></p>
                        <p class="text-gray-400 text-xs mt-1">Black text on white background</p>
                    </div>
                </div>
            </div>

            <!-- Text variations -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    Text Variations: <span class="text-purple-400" x-text="textVariations"></span>
                </label>
                <input type="range" min="1" max="10" x-model="textVariations"
                    class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                <p class="text-gray-500 text-xs mt-1">
                    Claude AI will generate <span x-text="textVariations - 1"></span> additional variations of your text
                </p>
            </div>

            <div class="flex justify-between">
                <button @click="prevStep()" class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold text-white transition-colors">
                    &larr; Back
                </button>
                <button @click="nextStep()" :disabled="!hookText.trim()"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 rounded-lg font-semibold text-white transition-colors">
                    Continue &rarr;
                </button>
            </div>
        </div>

        <!-- ==================== STEP 4: GENERATE ==================== -->
        <div x-show="currentStep === 4" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-white mb-4">Step 4: Generate</h2>

            <!-- Summary -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-400" x-text="selectedFormat?.clips?.length || 0"></div>
                    <div class="text-gray-400 text-sm">Clips</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-400" x-text="selectedCharacters.length"></div>
                    <div class="text-gray-400 text-sm">Characters</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-400" x-text="textVariations"></div>
                    <div class="text-gray-400 text-sm">Text Variations</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-400" x-text="numVideos"></div>
                    <div class="text-gray-400 text-sm">Videos</div>
                </div>
            </div>

            <!-- Config -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Asset Type</label>
                    <select x-model="assetType" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500">
                        <option value="photos">Photos only</option>
                        <option value="videos">Videos only</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        Number of Videos: <span class="text-purple-400" x-text="numVideos"></span>
                    </label>
                    <input type="range" min="1" max="50" x-model="numVideos"
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                </div>
            </div>

            <!-- Character selection -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">Include Characters</label>
                <div class="flex flex-wrap gap-2">
                    <template x-for="char in characters" :key="char.id">
                        <label class="flex items-center gap-2 px-3 py-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors"
                               :class="selectedCharacters.includes(char.id) ? 'ring-2 ring-purple-500' : ''">
                            <input type="checkbox" :value="char.id" x-model="selectedCharacters"
                                class="w-4 h-4 text-purple-500 bg-gray-700 border-gray-500 rounded">
                            <span class="text-gray-300 text-sm" x-text="char.character_name"></span>
                        </label>
                    </template>
                </div>
            </div>

            <div class="flex justify-between">
                <button @click="prevStep()" class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold text-white transition-colors">
                    &larr; Back
                </button>
                <button @click="submitGeneration()" :disabled="generating || selectedCharacters.length === 0"
                    class="px-8 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-lg font-bold text-white transition-colors text-lg">
                    <span x-show="!generating">Generate Videos</span>
                    <span x-show="generating">Submitting...</span>
                </button>
            </div>
        </div>

        <!-- ==================== STEP 5: PROGRESS ==================== -->
        <div x-show="currentStep === 5" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-white mb-4">Step 5: Progress</h2>

            <!-- Progress bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-400" x-text="jobStatus?.status || 'pending'"></span>
                    <span class="text-gray-400">
                        <span x-text="(jobStatus?.videos_completed || 0) + (jobStatus?.videos_failed || 0)"></span>
                        / <span x-text="jobStatus?.num_videos || 0"></span>
                    </span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500"
                         :class="jobStatus?.status === 'failed' ? 'bg-red-500' : jobStatus?.status === 'completed' ? 'bg-green-500' : 'bg-purple-500'"
                         :style="'width:' + progressPercent + '%'"></div>
                </div>
            </div>

            <!-- Status info -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-400" x-text="jobStatus?.videos_completed || 0"></div>
                    <div class="text-gray-400 text-sm">Completed</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-yellow-400" x-text="(jobStatus?.num_videos || 0) - (jobStatus?.videos_completed || 0) - (jobStatus?.videos_failed || 0)"></div>
                    <div class="text-gray-400 text-sm">Remaining</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-red-400" x-text="jobStatus?.videos_failed || 0"></div>
                    <div class="text-gray-400 text-sm">Failed</div>
                </div>
            </div>

            <!-- Drive link -->
            <div x-show="jobStatus?.drive_folder_url" class="mb-6 p-4 bg-green-900/30 border border-green-700 rounded-lg text-center">
                <p class="text-green-400 font-medium mb-2">Videos ready!</p>
                <a :href="jobStatus?.drive_folder_url" target="_blank"
                   class="inline-block px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition-colors">
                    Open Google Drive Folder
                </a>
            </div>

            <!-- Error -->
            <div x-show="jobStatus?.error_message" class="mb-6 p-4 bg-red-900/30 border border-red-700 rounded-lg">
                <p class="text-red-400" x-text="jobStatus?.error_message"></p>
            </div>

            <!-- Generate more -->
            <div x-show="jobStatus?.status === 'completed' || jobStatus?.status === 'failed'" class="text-center">
                <button @click="resetToStep(1)" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-white transition-colors">
                    Generate More
                </button>
            </div>
        </div>
    </div>

    <script>
    // Password protection
    function accessControl() {
        return {
            isAuthenticated: false,
            accessPassword: '',
            accessError: '',
            verifying: false,
            async verifyAccess() {
                this.verifying = true;
                this.accessError = '';
                try {
                    const r = await fetch('/api/verify-access', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({password: this.accessPassword})
                    });
                    const data = await r.json();
                    if (data.valid) {
                        this.isAuthenticated = true;
                        Alpine.store('auth').authenticated = true;
                    } else {
                        this.accessError = 'Invalid password';
                    }
                } catch (e) {
                    this.accessError = 'Connection error';
                }
                this.verifying = false;
            }
        }
    }

    // Main app
    function reelGenerator() {
        return {
            currentStep: 1,

            // Step 1: Format
            formats: [],
            selectedFormat: null,
            scrapeUrl: '',
            scrapeFormatName: '',
            scraping: false,
            scrapeError: '',

            // Step 2: Assets
            characters: [],
            newCharacterName: '',
            expandedCharacter: null,
            uploadingKey: null,

            // Step 3: Text
            hookText: '',
            ctaText: '',
            textVariations: 1,

            // Step 4: Generate
            assetType: 'photos',
            numVideos: 10,
            selectedCharacters: [],
            generating: false,

            // Step 5: Progress
            jobId: null,
            jobStatus: null,
            pollInterval: null,

            get progressPercent() {
                if (!this.jobStatus || !this.jobStatus.num_videos) return 0;
                const done = (this.jobStatus.videos_completed || 0) + (this.jobStatus.videos_failed || 0);
                return Math.round((done / this.jobStatus.num_videos) * 100);
            },

            async init() {
                await this.loadFormats();
                await this.loadCharacters();
            },

            nextStep() { if (this.currentStep < 5) this.currentStep++; },
            prevStep() { if (this.currentStep > 1) this.currentStep--; },
            resetToStep(n) {
                this.currentStep = n;
                this.jobId = null;
                this.jobStatus = null;
                if (this.pollInterval) clearInterval(this.pollInterval);
            },

            // ---- Format ----
            async loadFormats() {
                try {
                    const r = await fetch('/api/instagram-reel/formats');
                    const data = await r.json();
                    this.formats = data.formats || [];
                } catch (e) { console.error('Failed to load formats', e); }
            },

            selectFormat(fmt) {
                this.selectedFormat = JSON.parse(JSON.stringify(fmt));
            },

            async scrapeFormat() {
                this.scraping = true;
                this.scrapeError = '';
                try {
                    const r = await fetch('/api/instagram-reel/formats/scrape', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({url: this.scrapeUrl, format_name: this.scrapeFormatName})
                    });
                    const data = await r.json();
                    if (r.ok) {
                        await this.loadFormats();
                        this.selectedFormat = data;
                        this.scrapeUrl = '';
                        this.scrapeFormatName = '';
                    } else {
                        this.scrapeError = data.error || 'Scrape failed';
                    }
                } catch (e) {
                    this.scrapeError = 'Connection error';
                }
                this.scraping = false;
            },

            async saveFormatEdits() {
                if (!this.selectedFormat) return;
                try {
                    await fetch(`/api/instagram-reel/formats/${this.selectedFormat.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({clips: this.selectedFormat.clips})
                    });
                    await this.loadFormats();
                } catch (e) { console.error('Save failed', e); }
            },

            // ---- Characters ----
            async loadCharacters() {
                try {
                    const r = await fetch('/api/instagram-reel/characters');
                    const data = await r.json();
                    this.characters = data.characters || [];
                    // Auto-select all for generation
                    this.selectedCharacters = this.characters.map(c => c.id);
                } catch (e) { console.error('Failed to load characters', e); }
            },

            async createCharacter() {
                const name = this.newCharacterName.trim();
                if (!name) return;
                try {
                    const r = await fetch('/api/instagram-reel/characters', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name})
                    });
                    if (r.ok) {
                        this.newCharacterName = '';
                        await this.loadCharacters();
                    }
                } catch (e) { console.error('Create failed', e); }
            },

            async deleteCharacter(id) {
                if (!confirm('Delete this character and all its assets?')) return;
                try {
                    await fetch(`/api/instagram-reel/characters/${id}`, {method: 'DELETE'});
                    await this.loadCharacters();
                } catch (e) { console.error('Delete failed', e); }
            },

            toggleCharacter(id) {
                this.expandedCharacter = this.expandedCharacter === id ? null : id;
            },

            async handleAssetDrop(event, charId, assetType) {
                event.currentTarget.classList.remove('dragover');
                const files = event.dataTransfer.files;
                if (files.length) await this.uploadAssetFiles(charId, assetType, files);
            },

            async handleAssetSelect(event, charId, assetType) {
                const files = event.target.files;
                if (files.length) await this.uploadAssetFiles(charId, assetType, files);
                event.target.value = '';
            },

            async uploadAssetFiles(charId, assetType, files) {
                this.uploadingKey = charId + '_' + assetType;
                const formData = new FormData();
                formData.append('asset_type', assetType);
                for (const f of files) formData.append('files', f);

                try {
                    await fetch(`/api/instagram-reel/characters/${charId}/assets`, {
                        method: 'POST', body: formData
                    });
                    await this.loadCharacters();
                } catch (e) { console.error('Upload failed', e); }
                this.uploadingKey = null;
            },

            // ---- Generation ----
            async submitGeneration() {
                this.generating = true;
                try {
                    const r = await fetch('/api/instagram-reel/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            format_id: this.selectedFormat.id,
                            num_videos: parseInt(this.numVideos),
                            num_text_variations: parseInt(this.textVariations),
                            asset_type: this.assetType,
                            hook_text: this.hookText,
                            cta_text: this.ctaText,
                            character_ids: this.selectedCharacters
                        })
                    });
                    const data = await r.json();
                    if (r.ok) {
                        this.jobId = data.job_id;
                        this.currentStep = 5;
                        this.startPolling();
                    } else {
                        alert(data.error || 'Generation failed');
                    }
                } catch (e) {
                    alert('Connection error');
                }
                this.generating = false;
            },

            startPolling() {
                if (this.pollInterval) clearInterval(this.pollInterval);
                this.pollInterval = setInterval(async () => {
                    try {
                        const r = await fetch(`/api/instagram-reel/jobs/${this.jobId}/status`);
                        this.jobStatus = await r.json();

                        if (this.jobStatus.status === 'completed' || this.jobStatus.status === 'failed') {
                            clearInterval(this.pollInterval);
                            this.pollInterval = null;
                        }
                    } catch (e) { console.error('Poll failed', e); }
                }, 1500);
            }
        }
    }
    </script>
</body>
</html>
