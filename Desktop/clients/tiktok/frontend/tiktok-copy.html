<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Copy Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Password Protection Modal -->
    <div x-data="accessControl()" x-show="!isAuthenticated" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-4">
                <span class="text-4xl">&#128274;</span>
                <h2 class="text-xl font-bold text-white mt-2">Access Required</h2>
                <p class="text-gray-400 text-sm">Enter password to continue</p>
            </div>
            <form @submit.prevent="verifyAccess">
                <input
                    type="password"
                    x-model="accessPassword"
                    placeholder="Password"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 mb-3"
                    autofocus
                >
                <div x-show="accessError" class="text-red-400 text-sm mb-3 text-center" x-text="accessError"></div>
                <button
                    type="submit"
                    class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-white transition-colors"
                    :disabled="!accessPassword || verifying"
                >
                    <span x-show="!verifying">Access</span>
                    <span x-show="verifying">Verifying...</span>
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl" x-data="tiktokCopyTool()" x-init="$el.style.display = window.pageAuthenticated ? '' : 'none'">
        <!-- Header -->
        <div class="text-center mb-8">
            <a href="/" class="absolute top-4 left-4 text-gray-500 hover:text-gray-300 text-sm transition-colors">
                &larr; Back to Generator
            </a>
            <h1 class="text-3xl font-bold text-white mb-2">TikTok Copy Tool</h1>
            <p class="text-gray-400">Convert TikTok slideshows to MP4 videos</p>
        </div>

        <!-- Step 1: Paste Links -->
        <div x-show="!showLinkTable" class="bg-gray-800 rounded-xl p-6 shadow-xl mb-6">
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    <span class="text-xl mr-2">&#128203;</span>
                    Step 1: Paste TikTok Links
                </label>
                <textarea
                    x-model="rawLinks"
                    placeholder="https://www.tiktok.com/@user/photo/123456
https://www.tiktok.com/t/ABC123/
(one link per line)"
                    rows="6"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 resize-none font-mono text-sm"
                ></textarea>
                <p class="text-gray-500 text-xs mt-1" x-show="validLinkCount > 0">
                    <span class="text-green-400" x-text="validLinkCount"></span> valid link(s) detected
                </p>
            </div>

            <button
                type="button"
                @click="parseLinks()"
                :disabled="validLinkCount === 0"
                class="w-full py-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-bold text-white text-lg transition-colors"
            >
                Parse Links &rarr;
            </button>
        </div>

        <!-- Step 2: Configure Each Link -->
        <div x-show="showLinkTable" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">
                    <span class="mr-2">&#9881;</span>
                    Step 2: Configure Each Link
                </h2>
                <button
                    @click="resetForm()"
                    class="text-gray-400 hover:text-gray-300 text-sm"
                >
                    &larr; Back to paste
                </button>
            </div>

            <!-- Summary -->
            <div class="mb-4 p-3 bg-gray-700/50 rounded-lg flex items-center justify-between">
                <div class="text-gray-300 text-sm">
                    <span class="font-medium" x-text="parsedLinks.length"></span> links total
                    <span class="mx-2 text-gray-500">|</span>
                    <span class="text-purple-400" x-text="linksWithReplacement"></span> with slide replacement
                </div>
            </div>

            <!-- Links Configuration Table -->
            <div class="space-y-3 mb-6 max-h-96 overflow-y-auto">
                <template x-for="(link, index) in parsedLinks" :key="index">
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <!-- URL Row -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex-1 min-w-0 mr-4">
                                <p class="text-gray-300 text-sm font-mono truncate" x-text="link.url"></p>
                            </div>
                            <span class="text-gray-500 text-xs">#<span x-text="index + 1"></span></span>
                        </div>

                        <!-- Replacement Toggle -->
                        <label class="flex items-center cursor-pointer">
                            <input
                                type="checkbox"
                                x-model="link.enableReplacement"
                                class="w-4 h-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-500 focus:ring-offset-gray-800"
                            >
                            <span class="ml-2 text-gray-400 text-sm">Replace a slide with product photo</span>
                        </label>

                        <!-- Replacement Options (if enabled) -->
                        <div x-show="link.enableReplacement" x-transition class="mt-3 pt-3 border-t border-gray-600 grid grid-cols-2 gap-4">
                            <!-- Slide Number -->
                            <div>
                                <label class="block text-gray-400 text-xs mb-1">Slide #</label>
                                <input
                                    type="number"
                                    x-model.number="link.replaceSlide"
                                    min="1"
                                    placeholder="e.g., 2"
                                    class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white text-sm placeholder-gray-400 focus:outline-none focus:border-purple-500"
                                >
                            </div>

                            <!-- Product Photo -->
                            <div>
                                <label class="block text-gray-400 text-xs mb-1">Product Photo</label>
                                <div
                                    class="border border-dashed border-gray-500 rounded p-2 text-center cursor-pointer hover:border-purple-500 transition-colors"
                                    @click="$refs['fileInput' + index].click()"
                                    :class="{ 'border-green-500 bg-green-900/20': link.productPhoto }"
                                >
                                    <input
                                        type="file"
                                        :x-ref="'fileInput' + index"
                                        @change="handleFileSelect($event, index)"
                                        accept="image/*"
                                        class="hidden"
                                        :id="'fileInput' + index"
                                    >
                                    <div x-show="!link.productPhoto" class="text-gray-400 text-xs py-1">
                                        Click to upload
                                    </div>
                                    <div x-show="link.productPhoto" class="flex items-center justify-center text-green-400 text-xs">
                                        <span class="mr-1">&#10003;</span>
                                        <span x-text="link.productPhoto?.name?.substring(0, 15) + '...' || 'Uploaded'"></span>
                                        <button
                                            type="button"
                                            @click.stop="clearLinkPhoto(index)"
                                            class="ml-2 text-red-400 hover:text-red-300"
                                        >&times;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Submit Button -->
            <button
                type="button"
                @click="submitForm()"
                :disabled="isSubmitting || !canSubmit"
                class="w-full py-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-bold text-white text-lg transition-colors flex items-center justify-center"
            >
                <span x-show="!isSubmitting">
                    <span class="mr-2">&#127916;</span>
                    Convert <span x-text="parsedLinks.length"></span> Videos
                </span>
                <span x-show="isSubmitting" class="flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Submitting...
                </span>
            </button>

            <!-- Validation Error -->
            <div x-show="validationError" x-transition class="mt-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-300 text-sm">
                <span x-text="validationError"></span>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="errorMessage" x-transition class="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-300">
            <span x-text="errorMessage"></span>
        </div>

        <!-- Progress Section -->
        <div x-show="batchId" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Progress</h2>
                <span
                    class="px-3 py-1 rounded-full text-sm font-medium"
                    :class="{
                        'bg-yellow-900/50 text-yellow-300': batchStatus === 'pending' || batchStatus === 'processing',
                        'bg-green-900/50 text-green-300': batchStatus === 'completed',
                        'bg-red-900/50 text-red-300': batchStatus === 'failed'
                    }"
                    x-text="batchStatus"
                ></span>
            </div>

            <!-- Drive Folder Link -->
            <div x-show="driveFolderUrl" class="mb-4 p-3 bg-purple-900/30 rounded-lg">
                <a :href="driveFolderUrl" target="_blank" class="text-purple-400 hover:text-purple-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12.01 1.485c-2.082 0-3.754.02-3.743.047.01.02 1.708 3.001 3.774 6.62l3.76 6.574h3.76c2.071 0 3.75-.02 3.74-.047-.02-.02-1.73-3.001-3.8-6.62l-3.77-6.574zm-8.25 6.62c-2.06 0-3.74.02-3.73.047.01.02 1.72 3.001 3.8 6.62l3.77 6.574 3.76-.02 3.77-.047-3.8-6.62c-2.09-3.638-3.81-6.598-3.82-6.574-.01.02-1.72.02-3.75.02zm3.73 13.68l-3.76 6.62c-2.07 3.638-3.77 6.598-3.78 6.574-.01-.02-.01-3.001-.01-6.62v-6.574l3.78-.02 3.77-.047z"/>
                    </svg>
                    Open in Google Drive
                </a>
            </div>

            <!-- Jobs List -->
            <div class="space-y-2">
                <template x-for="job in jobs" :key="job.id">
                    <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-sm truncate" x-text="job.url"></p>
                            <p x-show="job.replace_slide" class="text-purple-400 text-xs mt-1">
                                Replacing slide #<span x-text="job.replace_slide"></span>
                            </p>
                        </div>
                        <div class="ml-3 flex items-center space-x-2">
                            <!-- Status Badge -->
                            <span
                                class="px-2 py-1 rounded text-xs font-medium whitespace-nowrap"
                                :class="{
                                    'bg-gray-600 text-gray-300': job.status === 'pending',
                                    'bg-yellow-900/50 text-yellow-300': job.status === 'processing',
                                    'bg-green-900/50 text-green-300': job.status === 'completed',
                                    'bg-red-900/50 text-red-300': job.status === 'failed'
                                }"
                            >
                                <span x-show="job.status === 'pending'">&#9208; Pending</span>
                                <span x-show="job.status === 'processing'">&#9203; Processing...</span>
                                <span x-show="job.status === 'completed'">&#9989; Done</span>
                                <span x-show="job.status === 'failed'">&#10060; Failed</span>
                            </span>
                            <!-- Drive Link (when completed) -->
                            <a
                                x-show="job.drive_url"
                                :href="job.drive_url"
                                target="_blank"
                                class="text-purple-400 hover:text-purple-300 text-sm"
                            >
                                Open
                            </a>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Error details -->
            <template x-for="job in jobs.filter(j => j.error)" :key="job.id + '_error'">
                <div class="mt-2 p-2 bg-red-900/30 rounded text-red-400 text-xs">
                    <span class="font-medium" x-text="job.url.substring(0, 30) + '...'"></span>:
                    <span x-text="job.error"></span>
                </div>
            </template>

            <!-- Auto-refresh indicator -->
            <div x-show="isPolling" class="mt-4 text-center text-gray-500 text-xs">
                Auto-refreshing every 3 seconds...
            </div>

            <!-- New Batch Button -->
            <div x-show="batchStatus === 'completed' || batchStatus === 'failed'" class="mt-4">
                <button
                    @click="resetAll()"
                    class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium text-white transition-colors"
                >
                    Start New Batch
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global auth state (sessionStorage clears on tab close)
        window.pageAuthenticated = sessionStorage.getItem('pageAuthenticated') === 'true';

        function accessControl() {
            return {
                isAuthenticated: window.pageAuthenticated,
                accessPassword: '',
                accessError: '',
                verifying: false,

                async verifyAccess() {
                    this.verifying = true;
                    this.accessError = '';
                    try {
                        const response = await fetch('/api/verify-access', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.accessPassword })
                        });
                        const data = await response.json();
                        if (data.valid) {
                            this.isAuthenticated = true;
                            window.pageAuthenticated = true;
                            sessionStorage.setItem('pageAuthenticated', 'true');
                            location.reload();
                        } else {
                            this.accessError = 'Invalid password';
                        }
                    } catch (e) {
                        this.accessError = 'Connection error';
                    }
                    this.verifying = false;
                }
            };
        }

        function tiktokCopyTool() {
            return {
                // Step 1: Raw links
                rawLinks: '',
                showLinkTable: false,

                // Step 2: Parsed links with per-link settings
                // Each link: {url, enableReplacement, replaceSlide, productPhoto, photoIndex}
                parsedLinks: [],

                // State
                isSubmitting: false,
                errorMessage: '',
                validationError: '',

                // Progress tracking
                batchId: null,
                batchStatus: null,
                driveFolderUrl: null,
                jobs: [],
                isPolling: false,
                pollInterval: null,

                // Computed
                get validLinkCount() {
                    if (!this.rawLinks.trim()) return 0;
                    const lines = this.rawLinks.trim().split('\n');
                    const tiktokPattern = /https?:\/\/(www\.|vm\.)?tiktok\.com\//;
                    return lines.filter(line => tiktokPattern.test(line.trim())).length;
                },

                get linksWithReplacement() {
                    return this.parsedLinks.filter(l => l.enableReplacement).length;
                },

                get canSubmit() {
                    // Check that all links with replacement enabled have valid settings
                    for (const link of this.parsedLinks) {
                        if (link.enableReplacement) {
                            if (!link.replaceSlide || link.replaceSlide < 1) return false;
                            if (!link.productPhoto) return false;
                        }
                    }
                    return this.parsedLinks.length > 0;
                },

                // Parse links and show configuration table
                parseLinks() {
                    const tiktokPattern = /https?:\/\/(www\.|vm\.)?tiktok\.com\/[^\s]+/;
                    const lines = this.rawLinks.trim().split('\n');

                    this.parsedLinks = [];
                    for (const line of lines) {
                        const url = line.trim();
                        if (url && tiktokPattern.test(url)) {
                            this.parsedLinks.push({
                                url: url,
                                enableReplacement: false,
                                replaceSlide: null,
                                productPhoto: null,
                                photoIndex: null
                            });
                        }
                    }

                    if (this.parsedLinks.length > 0) {
                        this.showLinkTable = true;
                    }
                },

                // File handling for per-link uploads
                handleFileSelect(event, index) {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.parsedLinks[index].productPhoto = file;
                    }
                },

                clearLinkPhoto(index) {
                    this.parsedLinks[index].productPhoto = null;
                    const input = document.getElementById('fileInput' + index);
                    if (input) input.value = '';
                },

                // Reset to step 1
                resetForm() {
                    this.showLinkTable = false;
                    this.parsedLinks = [];
                    this.validationError = '';
                },

                // Reset everything for new batch
                resetAll() {
                    this.rawLinks = '';
                    this.showLinkTable = false;
                    this.parsedLinks = [];
                    this.batchId = null;
                    this.batchStatus = null;
                    this.driveFolderUrl = null;
                    this.jobs = [];
                    this.errorMessage = '';
                    this.validationError = '';
                    this.stopPolling();
                },

                // Validate before submit
                validateForm() {
                    for (let i = 0; i < this.parsedLinks.length; i++) {
                        const link = this.parsedLinks[i];
                        if (link.enableReplacement) {
                            if (!link.replaceSlide || link.replaceSlide < 1) {
                                this.validationError = `Link #${i + 1}: Please enter a valid slide number`;
                                return false;
                            }
                            if (!link.productPhoto) {
                                this.validationError = `Link #${i + 1}: Please upload a product photo`;
                                return false;
                            }
                        }
                    }
                    this.validationError = '';
                    return true;
                },

                // Form submission with per-link settings
                async submitForm() {
                    this.errorMessage = '';
                    this.validationError = '';

                    if (!this.validateForm()) {
                        return;
                    }

                    this.isSubmitting = true;

                    try {
                        const formData = new FormData();

                        // Build links config and collect photos
                        const linksConfig = [];
                        let photoIndex = 0;

                        for (const link of this.parsedLinks) {
                            const config = {
                                url: link.url,
                                replace_slide: null,
                                photo_index: null
                            };

                            if (link.enableReplacement && link.replaceSlide && link.productPhoto) {
                                config.replace_slide = link.replaceSlide;
                                config.photo_index = photoIndex;

                                // Add photo to form data
                                formData.append(`product_photo_${photoIndex}`, link.productPhoto);
                                photoIndex++;
                            }

                            linksConfig.push(config);
                        }

                        // Add links config as JSON
                        formData.append('links_config', JSON.stringify(linksConfig));

                        const response = await fetch('/api/tiktok-copy/convert', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Submission failed');
                        }

                        // Success - start polling
                        this.batchId = data.batch_id;
                        this.jobs = data.jobs;
                        this.batchStatus = 'pending';
                        this.showLinkTable = false;
                        this.startPolling();

                    } catch (error) {
                        this.errorMessage = error.message;
                    } finally {
                        this.isSubmitting = false;
                    }
                },

                // Polling for status updates
                startPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }

                    this.isPolling = true;
                    this.pollStatus();

                    this.pollInterval = setInterval(() => {
                        this.pollStatus();
                    }, 3000);
                },

                async pollStatus() {
                    if (!this.batchId) return;

                    try {
                        const response = await fetch(`/api/tiktok-copy/status/${this.batchId}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.batchStatus = data.status;
                            this.driveFolderUrl = data.drive_folder_url;
                            this.jobs = data.jobs;

                            // Stop polling when complete or failed
                            if (data.status === 'completed' || data.status === 'failed') {
                                this.stopPolling();
                            }
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                },

                stopPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                    }
                    this.isPolling = false;
                }
            };
        }
    </script>
</body>
</html>
