<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Copy Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Password Protection Modal -->
    <div x-data="accessControl()" x-show="!isAuthenticated" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-4">
                <span class="text-4xl">&#128274;</span>
                <h2 class="text-xl font-bold text-white mt-2">Access Required</h2>
                <p class="text-gray-400 text-sm">Enter password to continue</p>
            </div>
            <form @submit.prevent="verifyAccess">
                <input
                    type="password"
                    x-model="accessPassword"
                    placeholder="Password"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 mb-3"
                    autofocus
                >
                <div x-show="accessError" class="text-red-400 text-sm mb-3 text-center" x-text="accessError"></div>
                <button
                    type="submit"
                    class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-white transition-colors"
                    :disabled="!accessPassword || verifying"
                >
                    <span x-show="!verifying">Access</span>
                    <span x-show="verifying">Verifying...</span>
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl" x-data="tiktokCopyTool()" x-init="$el.style.display = window.pageAuthenticated ? '' : 'none'">
        <!-- Header -->
        <div class="text-center mb-8">
            <a href="/" class="absolute top-4 left-4 text-gray-500 hover:text-gray-300 text-sm transition-colors">
                &larr; Back to Generator
            </a>
            <h1 class="text-3xl font-bold text-white mb-2">TikTok Copy Tool</h1>
            <p class="text-gray-400">Convert TikTok slideshows to MP4 videos with auto product replacement</p>
        </div>

        <!-- Main Form (hidden when batch is active) -->
        <div x-show="!batchId" class="bg-gray-800 rounded-xl p-6 shadow-xl mb-6">
            <!-- Step 1: Paste Links -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    Paste TikTok Links <span class="text-gray-500">(one per line)</span>
                </label>
                <textarea
                    x-model="rawLinks"
                    placeholder="https://www.tiktok.com/@user/photo/123456
https://www.tiktok.com/t/ABC123/
https://vm.tiktok.com/ABC123/"
                    rows="5"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 resize-none font-mono text-sm"
                ></textarea>
                <p class="text-gray-500 text-xs mt-1" x-show="validLinkCount > 0">
                    <span class="text-green-400 font-medium" x-text="validLinkCount"></span> valid link(s) detected
                </p>
            </div>

            <!-- Step 2: Mode Selection -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-3">Mode</label>
                <div class="flex space-x-4">
                    <label class="flex items-center cursor-pointer group">
                        <input type="radio" x-model="mode" value="auto-replace" class="w-4 h-4 text-purple-500 bg-gray-700 border-gray-500 focus:ring-purple-500 focus:ring-offset-gray-800">
                        <span class="ml-2 text-gray-300 group-hover:text-white transition-colors">Auto-replace product slide</span>
                    </label>
                    <label class="flex items-center cursor-pointer group">
                        <input type="radio" x-model="mode" value="no-replacement" class="w-4 h-4 text-purple-500 bg-gray-700 border-gray-500 focus:ring-purple-500 focus:ring-offset-gray-800">
                        <span class="ml-2 text-gray-300 group-hover:text-white transition-colors">No replacement (convert only)</span>
                    </label>
                </div>
                <p class="text-gray-500 text-xs mt-2" x-show="mode === 'auto-replace'">
                    AI will detect the product/ad slide in each slideshow and replace it with your selected photo.
                </p>
            </div>

            <!-- Step 3: Product Photo Selection (only for auto-replace) -->
            <div x-show="mode === 'auto-replace'" x-transition class="mb-6">
                <!-- Category Selector -->
                <label class="block text-gray-300 text-sm font-medium mb-2">Product Category</label>
                <div class="flex space-x-2 mb-4">
                    <template x-for="cat in categories" :key="cat.slug">
                        <button
                            @click="selectCategory(cat.slug)"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            :class="selectedCategory === cat.slug ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'"
                        >
                            <span x-text="cat.name"></span>
                            <span class="text-xs opacity-70 ml-1" x-text="'(' + cat.count + ')'"></span>
                        </button>
                    </template>
                </div>

                <!-- Photo Grid -->
                <div x-show="categoryPhotos.length > 0">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Select Photo</label>
                    <div class="grid grid-cols-5 gap-3">
                        <template x-for="photo in categoryPhotos" :key="photo.filename">
                            <div
                                @click="selectPhoto(photo)"
                                class="relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all hover:scale-105"
                                :class="selectedPhotoPath === photo.path ? 'border-purple-500 ring-2 ring-purple-500/50' : 'border-gray-600 hover:border-gray-500'"
                            >
                                <img
                                    :src="photo.url"
                                    :alt="photo.filename"
                                    class="w-full h-24 object-cover"
                                >
                                <div
                                    x-show="selectedPhotoPath === photo.path"
                                    class="absolute inset-0 bg-purple-600/30 flex items-center justify-center"
                                >
                                    <span class="text-white text-xl">&#10003;</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- No Photos Message -->
                <div x-show="categoryPhotos.length === 0 && selectedCategory" class="p-4 bg-gray-700/50 rounded-lg text-center">
                    <p class="text-gray-400 text-sm">No photos in this category.</p>
                    <a href="/admin/photos" class="text-purple-400 hover:text-purple-300 text-sm">Upload photos in Admin Panel</a>
                </div>

                <!-- Selected Photo Preview -->
                <div x-show="selectedPhotoPath" class="mt-3 flex items-center space-x-3 p-3 bg-purple-900/20 border border-purple-700/50 rounded-lg">
                    <img :src="selectedPhotoUrl" class="w-12 h-12 object-cover rounded">
                    <div class="flex-1">
                        <p class="text-purple-300 text-sm font-medium">Selected photo</p>
                        <p class="text-gray-400 text-xs" x-text="selectedPhotoFilename"></p>
                    </div>
                    <button @click="clearPhoto()" class="text-gray-400 hover:text-red-400 text-lg">&times;</button>
                </div>
            </div>

            <!-- Submit Button -->
            <button
                type="button"
                @click="submitBatch()"
                :disabled="!canSubmit || isSubmitting"
                class="w-full py-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-bold text-white text-lg transition-colors flex items-center justify-center"
            >
                <span x-show="!isSubmitting">
                    Convert <span x-text="validLinkCount"></span> Video<span x-show="validLinkCount !== 1">s</span>
                </span>
                <span x-show="isSubmitting" class="flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Submitting...
                </span>
            </button>
        </div>

        <!-- Error Message -->
        <div x-show="errorMessage" x-transition class="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-300">
            <span x-text="errorMessage"></span>
        </div>

        <!-- Progress Section -->
        <div x-show="batchId" x-transition class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Progress</h2>
                <div class="flex items-center space-x-3">
                    <span
                        x-show="batchMode"
                        class="px-2 py-0.5 rounded text-xs font-medium bg-gray-700 text-gray-300"
                        x-text="batchMode === 'auto-replace' ? 'Auto-detect' : (batchMode === 'no-replacement' ? 'No replacement' : 'Manual')"
                    ></span>
                    <span
                        class="px-3 py-1 rounded-full text-sm font-medium"
                        :class="{
                            'bg-yellow-900/50 text-yellow-300': batchStatus === 'pending' || batchStatus === 'processing',
                            'bg-green-900/50 text-green-300': batchStatus === 'completed',
                            'bg-red-900/50 text-red-300': batchStatus === 'failed'
                        }"
                        x-text="batchStatus"
                    ></span>
                </div>
            </div>

            <!-- Drive Folder Link -->
            <div x-show="driveFolderUrl" class="mb-4 p-3 bg-purple-900/30 rounded-lg">
                <a :href="driveFolderUrl" target="_blank" class="text-purple-400 hover:text-purple-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12.01 1.485c-2.082 0-3.754.02-3.743.047.01.02 1.708 3.001 3.774 6.62l3.76 6.574h3.76c2.071 0 3.75-.02 3.74-.047-.02-.02-1.73-3.001-3.8-6.62l-3.77-6.574zm-8.25 6.62c-2.06 0-3.74.02-3.73.047.01.02 1.72 3.001 3.8 6.62l3.77 6.574 3.76-.02 3.77-.047-3.8-6.62c-2.09-3.638-3.81-6.598-3.82-6.574-.01.02-1.72.02-3.75.02zm3.73 13.68l-3.76 6.62c-2.07 3.638-3.77 6.598-3.78 6.574-.01-.02-.01-3.001-.01-6.62v-6.574l3.78-.02 3.77-.047z"/>
                    </svg>
                    Open in Google Drive
                </a>
            </div>

            <!-- Jobs List -->
            <div class="space-y-2">
                <template x-for="job in jobs" :key="job.id">
                    <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-sm truncate" x-text="job.url"></p>
                            <!-- Detection result -->
                            <p x-show="job.product_slide_detected" class="text-purple-400 text-xs mt-1">
                                Replaced slide #<span x-text="job.product_slide_detected"></span>
                            </p>
                            <p x-show="job.detection_skipped && job.status === 'completed'" class="text-gray-500 text-xs mt-1">
                                No product slide found
                            </p>
                            <!-- Legacy manual mode -->
                            <p x-show="job.replace_slide && !job.product_slide_detected" class="text-purple-400 text-xs mt-1">
                                Replacing slide #<span x-text="job.replace_slide"></span>
                            </p>
                        </div>
                        <div class="ml-3 flex items-center space-x-2">
                            <!-- Status Badge -->
                            <span
                                class="px-2 py-1 rounded text-xs font-medium whitespace-nowrap"
                                :class="{
                                    'bg-gray-600 text-gray-300': job.status === 'pending',
                                    'bg-yellow-900/50 text-yellow-300': job.status === 'processing',
                                    'bg-green-900/50 text-green-300': job.status === 'completed',
                                    'bg-red-900/50 text-red-300': job.status === 'failed'
                                }"
                            >
                                <span x-show="job.status === 'pending'">Pending</span>
                                <span x-show="job.status === 'processing'">Processing...</span>
                                <span x-show="job.status === 'completed'">Done</span>
                                <span x-show="job.status === 'failed'">Failed</span>
                            </span>
                            <!-- Drive Link (when completed) -->
                            <a
                                x-show="job.drive_url"
                                :href="job.drive_url"
                                target="_blank"
                                class="text-purple-400 hover:text-purple-300 text-sm"
                            >
                                Open
                            </a>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Error details -->
            <template x-for="job in jobs.filter(j => j.error)" :key="job.id + '_error'">
                <div class="mt-2 p-2 bg-red-900/30 rounded text-red-400 text-xs">
                    <span class="font-medium" x-text="job.url.substring(0, 30) + '...'"></span>:
                    <span x-text="job.error"></span>
                </div>
            </template>

            <!-- Auto-refresh indicator -->
            <div x-show="isPolling" class="mt-4 text-center text-gray-500 text-xs">
                Auto-refreshing every 3 seconds...
            </div>

            <!-- New Batch Button -->
            <div x-show="batchStatus === 'completed' || batchStatus === 'failed'" class="mt-4">
                <button
                    @click="resetAll()"
                    class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium text-white transition-colors"
                >
                    Start New Batch
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global auth state (sessionStorage clears on tab close)
        window.pageAuthenticated = sessionStorage.getItem('pageAuthenticated') === 'true';

        function accessControl() {
            return {
                isAuthenticated: window.pageAuthenticated,
                accessPassword: '',
                accessError: '',
                verifying: false,

                async verifyAccess() {
                    this.verifying = true;
                    this.accessError = '';
                    try {
                        const response = await fetch('/api/verify-access', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.accessPassword })
                        });
                        const data = await response.json();
                        if (data.valid) {
                            this.isAuthenticated = true;
                            window.pageAuthenticated = true;
                            sessionStorage.setItem('pageAuthenticated', 'true');
                            location.reload();
                        } else {
                            this.accessError = 'Invalid password';
                        }
                    } catch (e) {
                        this.accessError = 'Connection error';
                    }
                    this.verifying = false;
                }
            };
        }

        function tiktokCopyTool() {
            return {
                // Form state
                rawLinks: '',
                mode: 'auto-replace',

                // Product photo selection
                categories: [],
                selectedCategory: 'face_tape',
                categoryPhotos: [],
                selectedPhotoPath: null,
                selectedPhotoUrl: null,
                selectedPhotoFilename: null,

                // State
                isSubmitting: false,
                errorMessage: '',

                // Progress tracking
                batchId: null,
                batchStatus: null,
                batchMode: null,
                driveFolderUrl: null,
                jobs: [],
                isPolling: false,
                pollInterval: null,

                // Computed
                get validLinkCount() {
                    if (!this.rawLinks.trim()) return 0;
                    const lines = this.rawLinks.trim().split('\n');
                    const tiktokPattern = /https?:\/\/(www\.|vm\.)?tiktok\.com\//;
                    return lines.filter(line => tiktokPattern.test(line.trim())).length;
                },

                get validLinks() {
                    if (!this.rawLinks.trim()) return [];
                    const lines = this.rawLinks.trim().split('\n');
                    const tiktokPattern = /https?:\/\/(www\.|vm\.)?tiktok\.com\/[^\s]+/;
                    return lines.map(l => l.trim()).filter(l => l && tiktokPattern.test(l));
                },

                get canSubmit() {
                    if (this.validLinkCount === 0) return false;
                    if (this.mode === 'auto-replace' && !this.selectedPhotoPath) return false;
                    return true;
                },

                // Init: load product photos
                init() {
                    this.fetchCategories();
                },

                async fetchCategories() {
                    try {
                        const res = await fetch('/api/tiktok-copy/product-photos');
                        if (res.ok) {
                            const data = await res.json();
                            this.categories = data.categories || [];
                            // Load photos for default category
                            this.loadCategoryPhotos();
                        }
                    } catch (e) {
                        console.error('Failed to fetch categories:', e);
                    }
                },

                selectCategory(slug) {
                    this.selectedCategory = slug;
                    this.loadCategoryPhotos();
                },

                loadCategoryPhotos() {
                    const cat = this.categories.find(c => c.slug === this.selectedCategory);
                    this.categoryPhotos = cat ? cat.photos : [];
                },

                selectPhoto(photo) {
                    this.selectedPhotoPath = photo.path;
                    this.selectedPhotoUrl = photo.url;
                    this.selectedPhotoFilename = photo.filename;
                },

                clearPhoto() {
                    this.selectedPhotoPath = null;
                    this.selectedPhotoUrl = null;
                    this.selectedPhotoFilename = null;
                },

                // Submit batch
                async submitBatch() {
                    this.errorMessage = '';
                    this.isSubmitting = true;

                    try {
                        const payload = {
                            links: this.validLinks,
                            mode: this.mode,
                            product_photo_path: this.mode === 'auto-replace' ? this.selectedPhotoPath : null
                        };

                        const response = await fetch('/api/tiktok-copy/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Submission failed');
                        }

                        // Success - start polling
                        this.batchId = data.batch_id;
                        this.batchMode = data.mode;
                        this.jobs = data.jobs;
                        this.batchStatus = 'pending';
                        this.startPolling();

                    } catch (error) {
                        this.errorMessage = error.message;
                    } finally {
                        this.isSubmitting = false;
                    }
                },

                // Reset everything for new batch
                resetAll() {
                    this.rawLinks = '';
                    this.mode = 'auto-replace';
                    this.batchId = null;
                    this.batchStatus = null;
                    this.batchMode = null;
                    this.driveFolderUrl = null;
                    this.jobs = [];
                    this.errorMessage = '';
                    this.stopPolling();
                },

                // Polling for status updates
                startPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }

                    this.isPolling = true;
                    this.pollStatus();

                    this.pollInterval = setInterval(() => {
                        this.pollStatus();
                    }, 3000);
                },

                async pollStatus() {
                    if (!this.batchId) return;

                    try {
                        const response = await fetch(`/api/tiktok-copy/status/${this.batchId}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.batchStatus = data.status;
                            this.batchMode = data.mode;
                            this.driveFolderUrl = data.drive_folder_url;
                            this.jobs = data.jobs;

                            // Stop polling when complete or failed
                            if (data.status === 'completed' || data.status === 'failed') {
                                this.stopPolling();
                            }
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                },

                stopPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                    }
                    this.isPolling = false;
                }
            };
        }
    </script>
</body>
</html>
