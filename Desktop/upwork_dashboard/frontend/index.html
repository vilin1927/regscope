<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upwork Niche Analyzer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Upwork Niche Analyzer</h1>
            <p class="text-gray-600" id="stats-summary">Loading...</p>
        </div>

        <!-- Top 10 Niches Table -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Top 10 Niches</h2>
                <div class="flex gap-2">
                    <button id="reset-filter-btn" class="hidden px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        Reset Filters
                    </button>
                    <button id="export-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        Export to CSV
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Niche</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jobs</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Budget</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget Confidence</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Top Solution</th>
                        </tr>
                    </thead>
                    <tbody id="niches-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-4 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Niche-Solution Matrix -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Niche-Solution Matrix</h2>
            <p class="text-sm text-gray-600 mb-4">Click any cell to filter by solution category</p>

            <div class="overflow-x-auto">
                <div id="matrix-container">
                    <p class="text-center text-gray-500 py-4">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentFilter = null;

        // Fetch and display stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                const data = await response.json();

                document.getElementById('stats-summary').textContent =
                    `Analyzed ${data.total_jobs.toLocaleString()} jobs | ` +
                    `${data.valid_jobs.toLocaleString()} valid | ` +
                    `${data.unique_niches} unique niches`;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-summary').textContent = 'Failed to load stats';
            }
        }

        // Fetch and display top niches
        async function loadTopNiches(solutionFilter = null) {
            try {
                let url = `${API_BASE_URL}/top-niches?min_jobs=20`;
                if (solutionFilter) {
                    url += `&solution=${encodeURIComponent(solutionFilter)}`;
                    currentFilter = solutionFilter;
                    document.getElementById('reset-filter-btn').classList.remove('hidden');
                } else {
                    currentFilter = null;
                    document.getElementById('reset-filter-btn').classList.add('hidden');
                }

                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.getElementById('niches-table-body');

                if (!data.niches || data.niches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No niches found with 20+ jobs</td></tr>';
                    return;
                }

                tbody.innerHTML = data.niches.map(niche => {
                    const confidenceClass = niche.high_confidence_pct < 50 ? 'text-yellow-600' : 'text-green-600';
                    const warningIcon = niche.high_confidence_pct < 50 ? ' ⚠️' : '';

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-900">${niche.rank}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${niche.niche}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${niche.job_count}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">$${niche.avg_budget.toLocaleString()}</td>
                            <td class="px-4 py-3 text-sm ${confidenceClass}">${niche.high_confidence_pct}%${warningIcon}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${niche.top_solution}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading niches:', error);
                document.getElementById('niches-table-body').innerHTML =
                    '<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">Failed to load data. Is the API server running?</td></tr>';
            }
        }

        // Fetch and display matrix
        async function loadMatrix() {
            try {
                const response = await fetch(`${API_BASE_URL}/niche-solution-matrix`);
                const data = await response.json();

                if (!data.niches || data.niches.length === 0) {
                    document.getElementById('matrix-container').innerHTML =
                        '<p class="text-center text-gray-500 py-4">No data available</p>';
                    return;
                }

                const top3Set = new Set(data.top_3.map(combo => `${combo.niche}:${combo.solution}`));

                let html = '<table class="min-w-full border-collapse text-sm">';

                // Header row
                html += '<thead><tr><th class="border border-gray-300 px-3 py-2 bg-gray-50 font-semibold">Niche</th>';
                data.solutions.forEach(solution => {
                    html += `<th class="border border-gray-300 px-3 py-2 bg-gray-50 font-semibold text-center">${solution}</th>`;
                });
                html += '</tr></thead>';

                // Data rows
                html += '<tbody>';
                data.matrix.forEach(row => {
                    html += '<tr>';
                    html += `<td class="border border-gray-300 px-3 py-2 font-medium text-gray-800">${row.niche}</td>`;

                    data.solutions.forEach(solution => {
                        const count = row.counts[solution] || 0;
                        const key = `${row.niche}:${solution}`;
                        const isTop3 = top3Set.has(key);

                        const cellClass = isTop3 ? 'bg-blue-100 font-bold' : count > 0 ? 'hover:bg-gray-100 cursor-pointer' : 'bg-gray-50';
                        const textClass = count > 0 ? 'text-blue-600' : 'text-gray-400';

                        html += `<td class="border border-gray-300 px-3 py-2 text-center ${cellClass} ${textClass}"
                                     onclick="${count > 0 ? `filterBySolution('${solution}')` : ''}"
                                     title="${count > 0 ? 'Click to filter' : ''}">
                                     ${count}
                                 </td>`;
                    });

                    html += '</tr>';
                });
                html += '</tbody></table>';

                document.getElementById('matrix-container').innerHTML = html;
            } catch (error) {
                console.error('Error loading matrix:', error);
                document.getElementById('matrix-container').innerHTML =
                    '<p class="text-center text-red-500 py-4">Failed to load matrix data</p>';
            }
        }

        // Filter by solution
        function filterBySolution(solution) {
            loadTopNiches(solution);
        }

        // Reset filters
        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            loadTopNiches(null);
        });

        // Export to CSV
        document.getElementById('export-btn').addEventListener('click', async () => {
            try {
                let url = `${API_BASE_URL}/top-niches?min_jobs=20`;
                if (currentFilter) {
                    url += `&solution=${encodeURIComponent(currentFilter)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.niches || data.niches.length === 0) {
                    alert('No data to export');
                    return;
                }

                // Create CSV
                const csv = [
                    ['Rank', 'Niche', 'Jobs', 'Avg Budget', 'Budget Confidence %', 'Top Solution'],
                    ...data.niches.map(n => [
                        n.rank,
                        n.niche,
                        n.job_count,
                        n.avg_budget.toFixed(0),
                        n.high_confidence_pct,
                        n.top_solution
                    ])
                ].map(row => row.join(',')).join('\n');

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url2 = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url2;
                a.download = 'upwork_niches.csv';
                a.click();
                window.URL.revokeObjectURL(url2);
            } catch (error) {
                console.error('Error exporting:', error);
                alert('Failed to export data');
            }
        });

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadTopNiches();
            loadMatrix();
        });
    </script>
</body>
</html>
